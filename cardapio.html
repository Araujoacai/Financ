<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-open {
            overflow: hidden;
        }
        .item-added {
            animation: pulse 0.5s ease-out;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto max-w-4xl p-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img id="logo-img" src="https://placehold.co/150x50/ffffff/9ca3af?text=LOGO" alt="Logo" class="h-8 w-auto" onerror="this.src='https://placehold.co/150x50/ffffff/9ca3af?text=LOGO';">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Nosso Cardápio</h1>
            </div>
            <div id="table-display" class="text-right">
                <span class="text-xs text-gray-500 block">Mesa</span>
                <span id="table-name-display" class="font-bold text-blue-600">...</span>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main id="main-content" class="container mx-auto max-w-4xl p-4 sm:p-6 hidden">
        
        <!-- Filtro de Categorias -->
        <nav class="mb-6">
            <h2 class="text-sm font-semibold text-gray-600 mb-3">Categorias</h2>
            <div id="category-filters" class="flex flex-wrap gap-2">
                <!-- Botões de filtro serão inseridos aqui -->
                <span class="text-gray-500">A carregar categorias...</span>
            </div>
        </nav>

        <!-- Seções do Cardápio -->
        <div id="menu-sections" class="space-y-8">
            <!-- Seções de categoria e produtos serão inseridas aqui -->
            <p id="menu-loader" class="text-center text-gray-500 py-10">A carregar cardápio...</p>
        </div>

    </main>

    <!-- Botão Flutuante do Carrinho -->
    <button id="open-cart-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg z-50 flex items-center justify-center hover:bg-blue-700 transition-transform hover:scale-105">
        <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" /></svg>
        <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full px-2 py-0.5 min-w-[24px] hidden">0</span>
    </button>

    <!-- Modal: Seleção de Mesa (Inicial) -->
    <div id="table-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Bem-vindo(a)!</h2>
            <p class="text-gray-600 mb-6">Por favor, selecione a sua mesa para continuar:</p>
            <form id="table-select-form">
                <select id="table-select" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6" required>
                    <option value="" disabled selected>-- Carregando mesas... --</option>
                </select>
                <button type="submit" id="table-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>
                    Aceder ao Cardápio
                </button>
            </form>
            <p id="table-error" class="text-red-600 text-sm text-center mt-4 hidden">
                Não foi possível conectar ao servidor. Verifique a sua internet e tente recarregar.
            </p>
        </div>
    </div>

    <!-- Modal: Carrinho / Resumo do Pedido -->
    <div id="cart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden modal-open">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col transform transition-all">
            <!-- Cabeçalho -->
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-2xl font-bold text-gray-800">Seu Pedido</h3>
                <button id="close-cart-modal" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <!-- Conteúdo -->
            <div id="cart-content" class="p-6 overflow-y-auto">
                <div id="cart-items-list" class="space-y-4">
                    <!-- Itens do carrinho ou mensagem de vazio -->
                </div>
                
                <!-- Observações -->
                <div class="mt-6">
                    <label for="order-notes" class="block text-sm font-medium text-gray-700 mb-1">Observações (opcional):</label>
                    <textarea id="order-notes" rows="3" placeholder="Ex: Sem cebola, ponto da carne, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <!-- Rodapé (Total e Ação) -->
            <div class="p-5 border-t bg-gray-50 rounded-b-xl">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-bold text-gray-600">Total:</span>
                    <span id="cart-total" class="text-2xl font-bold text-gray-900">R$ 0,00</span>
                </div>
                <button id="submit-order-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center disabled:opacity-50">
                    <span id="submit-order-text">Finalizar Pedido</span>
                    <div id="submit-order-spinner" class="btn-loader ml-2 hidden"></div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Pedido Enviado (Sucesso) -->
    <div id="success-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden modal-open">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-3">Pedido Enviado!</h2>
            <p class="text-gray-600 mb-6">O seu pedido foi enviado para a cozinha. Em breve será servido!</p>
            <button id="close-success-modal" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                Pedir mais itens
            </button>
        </div>
    </div>


    <!-- Firebase e JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc,
            getDocs,
            addDoc,
            Timestamp,
            query,
            where,
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Importar configuração
        let firebaseConfig, restaurantAppId;
        try {
            const configModule = await import('./firebase-config.js');
            firebaseConfig = configModule.firebaseConfig;
            restaurantAppId = configModule.restaurantAppId;
            if (!firebaseConfig || !restaurantAppId) {
                throw new Error("Configuração incompleta.");
            }
        } catch (e) {
            console.error("Erro fatal: Não foi possível carregar 'firebase-config.js'.", e);
            document.getElementById('table-error').innerText = 'Erro de Configuração. Verifique o console (F12) e o arquivo firebase-config.js.';
            document.getElementById('table-error').classList.remove('hidden');
        }

        let app, auth, db, userId;
        let selectedTableId = null;
        let selectedTableName = null;
        let cart = []; // Nosso carrinho
        let categoriesCache = []; // Cache para nomes
        let productsCache = []; // Cache para produtos

        const mainContent = document.getElementById('main-content');
        const menuLoader = document.getElementById('menu-loader');
        const tableNameDisplay = document.getElementById('table-name-display');
        
        // Modal de Mesa
        const tableModal = document.getElementById('table-modal');
        const tableSelectForm = document.getElementById('table-select-form');
        const tableSelect = document.getElementById('table-select');
        const tableSubmitBtn = document.getElementById('table-submit-btn');
        const tableError = document.getElementById('table-error');
        
        // Cardápio
        const categoryFilters = document.getElementById('category-filters');
        const menuSections = document.getElementById('menu-sections');
        
        // Carrinho
        const openCartBtn = document.getElementById('open-cart-btn');
        const cartCountBadge = document.getElementById('cart-count-badge');
        const cartModal = document.getElementById('cart-modal');
        const closeCartModal = document.getElementById('close-cart-modal');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotal = document.getElementById('cart-total');
        const orderNotes = document.getElementById('order-notes');
        const submitOrderBtn = document.getElementById('submit-order-btn');
        const submitOrderText = document.getElementById('submit-order-text');
        const submitOrderSpinner = document.getElementById('submit-order-spinner');

        // Modal de Sucesso
        const successModal = document.getElementById('success-modal');
        const closeSuccessModal = document.getElementById('close-success-modal');
        
        // Logo
        const logoImg = document.getElementById('logo-img');

        const getCollectionPath = (colName) => `artifacts/${restaurantAppId}/public/data/${colName}`;

        async function initFirebase() {
             if (!firebaseConfig) {
                 tableError.innerText = "Erro de Configuração. Verifique o console (F12).";
                 tableError.classList.remove('hidden');
                 return;
             }
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuário está logado (anonimamente)
                        userId = user.uid;
                        console.log("Logado anonimamente com UID:", userId);
                        
                        // 1. Verificar se a URL tem um tableId
                        const urlParams = new URLSearchParams(window.location.search);
                        const tableIdFromUrl = urlParams.get('tableId');

                        // 2. Carregar mesas (necessário em ambos os casos)
                        await loadTables();

                        if (tableIdFromUrl) {
                            // 3. Se veio da URL (QR Code), tentar validar a mesa
                            const tableExists = validateTableFromUrl(tableIdFromUrl);
                            if (tableExists) {
                                // Selecionar mesa, fechar modal e carregar cardápio
                                selectMesa(tableIdFromUrl, selectedTableName);
                            } else {
                                // Mesa inválida, mostrar modal de seleção
                                console.warn("TableId da URL é inválido ou inativo. A mostrar seleção manual.");
                                tableModal.classList.remove('hidden');
                            }
                        } else {
                            // 4. Se não veio da URL, mostrar modal de seleção
                            tableModal.classList.remove('hidden');
                        }
                        
                    } else {
                        // Tentar login anônimo
                        await signInAnonymously(auth);
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                tableError.classList.remove('hidden');
            }
        }
        
        // Carregar mesas ativas para o select
        async function loadTables() {
            try {
                const tablesCol = collection(db, getCollectionPath('tables'));
                // REMOVIDO `where("active", "==", true)` para evitar índice
                const snapshot = await getDocs(query(tablesCol));
                
                if (snapshot.empty) {
                    tableSelect.innerHTML = '<option value="" disabled>Nenhuma mesa encontrada</option>';
                    return;
                }
                
                let optionsHtml = '<option value="" disabled selected>-- Selecione sua mesa --</option>';
                let tablesCache = []; // Cache para validar URL
                
                snapshot.forEach(doc => {
                    const table = { id: doc.id, ...doc.data() };
                    // FILTRO JS: Mostrar apenas se active for true ou indefinido (para mesas antigas)
                    if (table.active === true || typeof table.active === 'undefined') {
                        optionsHtml += `<option value="${table.id}">${table.name}</option>`;
                        tablesCache.push(table);
                    }
                });
                
                tableSelect.innerHTML = optionsHtml;
                tableSubmitBtn.disabled = false;
                
                // Salvar cache para validação de URL
                sessionStorage.setItem('tablesCache', JSON.stringify(tablesCache));

            } catch (error) {
                console.error("Erro ao carregar mesas:", error);
                tableError.classList.remove('hidden');
            }
        }
        
        // Validar se o tableId da URL é de uma mesa ativa
        function validateTableFromUrl(tableId) {
            const tablesCache = JSON.parse(sessionStorage.getItem('tablesCache') || '[]');
            const table = tablesCache.find(t => t.id === tableId);
            if (table) {
                selectedTableId = table.id;
                selectedTableName = table.name;
                return true;
            }
            return false;
        }

        // Evento de seleção de mesa
        tableSelectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const tableId = tableSelect.value;
            const tableName = tableSelect.options[tableSelect.selectedIndex].text;
            if (tableId) {
                selectMesa(tableId, tableName);
            }
        });

        // Ação de selecionar a mesa e carregar o app
        function selectMesa(id, name) {
            selectedTableId = id;
            selectedTableName = name;
            
            tableNameDisplay.innerText = name;
            tableModal.classList.add('hidden');
            mainContent.classList.remove('hidden');
            
            // Carregar o restante do app
            loadConfig();
            loadMenu();
        }
        
        // Carregar logo
        async function loadConfig() {
            try {
                const configDocRef = doc(db, getCollectionPath('config'), 'main');
                const docSnap = await getDoc(configDocRef);
                if (docSnap.exists() && docSnap.data().logoUrl) {
                    logoImg.src = docSnap.data().logoUrl;
                }
            } catch (error) {
                console.error("Erro ao carregar config:", error);
            }
        }

        // Carregar categorias e produtos
        async function loadMenu() {
            try {
                // 1. Carregar Categorias
                const categoriesCol = collection(db, getCollectionPath('categories'));
                // REMOVIDO `where("active", "==", true)`
                const categoriesSnap = await getDocs(query(categoriesCol));
                
                categoriesCache = [];
                let categoryButtonsHtml = '<button class="category-filter-btn active" data-category-id="all">Todos</button>';
                
                categoriesSnap.forEach(doc => {
                    const category = { id: doc.id, ...doc.data() };
                    // FILTRO JS
                    if (category.active) {
                        categoriesCache.push(category);
                        categoryButtonsHtml += `
                            <button class="category-filter-btn" data-category-id="${category.id}">
                                ${category.name}
                            </button>
                        `;
                    }
                });
                categoryFilters.innerHTML = categoryButtonsHtml;

                // 2. Carregar Produtos
                const productsCol = collection(db, getCollectionPath('products'));
                // REMOVIDO `where("active", "==", true)`
                const productsSnap = await getDocs(query(productsCol));
                
                productsCache = [];
                productsSnap.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    // FILTRO JS
                    if (product.active) {
                        productsCache.push(product);
                    }
                });
                
                menuLoader.classList.add('hidden');
                renderMenu();
                setupCategoryFilter();

            } catch (error) {
                console.error("Erro ao carregar cardápio:", error);
                menuLoader.innerText = "Erro ao carregar o cardápio. Tente recarregar a página.";
            }
        }
        
        // Renderizar o menu baseado nos dados cacheados
        function renderMenu() {
            menuSections.innerHTML = '';
            
            if (productsCache.length === 0) {
                 menuSections.innerHTML = '<p class="text-center text-gray-500 py-10">Nenhum produto encontrado.</p>';
                 return;
            }
            
            // Agrupar produtos por categoria
            categoriesCache.forEach(category => {
                const productsInCategory = productsCache.filter(p => p.categoryId === category.id);
                
                // Só renderizar a seção se houver produtos nela
                if (productsInCategory.length > 0) {
                    let productsHtml = '';
                    productsInCategory.forEach(product => {
                        productsHtml += createProductCard(product);
                    });
                    
                    menuSections.innerHTML += `
                        <section id="category-section-${category.id}" class="menu-category-section">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">${category.name}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${productsHtml}
                            </div>
                        </section>
                    `;
                }
            });
            
            // Adicionar listeners aos botões "Adicionar"
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('.product-card').dataset.id;
                    addToCart(id);
                    // Feedback visual
                    e.target.innerText = "Adicionado!";
                    e.target.classList.add('bg-green-600', 'hover:bg-green-700');
                    e.target.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    setTimeout(() => {
                        e.target.innerText = "Adicionar";
                        e.target.classList.remove('bg-green-600', 'hover:bg-green-700');
                        e.target.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }, 1000);
                });
            });
        }
        
        // Criar o HTML de um produto
        function createProductCard(product) {
            const price = parseFloat(product.price || 0).toFixed(2).replace('.', ',');
            const placeholder = "https://placehold.co/100x100/e5e7eb/9ca3af?text=Img";
            const imageUrl = product.imageUrl || placeholder;

            return `
                <div class="product-card bg-white p-4 rounded-xl shadow-md flex gap-4" data-id="${product.id}">
                    <div class="flex-grow">
                        <h3 class="text-lg font-bold text-gray-800">${product.name}</h3>
                        <p class="text-sm text-gray-600 my-1">${product.description || ''}</p>
                        <span class="text-lg font-bold text-blue-600">R$ ${price}</span>
                        <button class="add-to-cart-btn mt-3 w-full sm:w-auto bg-blue-600 text-white font-medium py-1.5 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            Adicionar
                        </button>
                    </div>
                    <img src="${imageUrl}" 
                         alt="${product.name}" 
                         class="w-24 h-24 sm:w-28 sm:h-28 rounded-md object-cover flex-shrink-0 bg-gray-200 text-transparent"
                         onerror="this.src='${placeholder}'; this.onerror=null;">
                </div>
            `;
        }

        // Lógica do Filtro de Categoria
        function setupCategoryFilter() {
            const filterButtons = document.querySelectorAll('.category-filter-btn');
            const productSections = document.querySelectorAll('.menu-category-section');

            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const categoryId = button.dataset.categoryId;

                    // Atualizar botão ativo
                    filterButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
                    filterButtons.forEach(btn => btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50'));
                    
                    button.classList.add('active', 'bg-blue-600', 'text-white');
                    button.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');

                    // Mostrar/Ocultar seções de produtos
                    productSections.forEach(section => {
                        if (categoryId === 'all' || section.id === `category-section-${categoryId}`) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    });
                    
                    // Ajustar estilo dos botões
                    filterButtons.forEach(btn => {
                        if (btn.classList.contains('active')) {
                            btn.className = "category-filter-btn active py-2 px-4 rounded-full font-medium text-sm transition-colors bg-blue-600 text-white";
                        } else {
                            btn.className = "category-filter-btn py-2 px-4 rounded-full font-medium text-sm transition-colors bg-white text-gray-700 hover:bg-gray-50 border";
                        }
                    });
                });
            });
            
            // Ativar o botão "Todos" por padrão
            document.querySelector('.category-filter-btn[data-category-id="all"]').click();
        }


        // --- Funções do Carrinho ---

        function addToCart(productId) {
            const product = productsCache.find(p => p.id === productId);
            if (!product) return;
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            updateCartUI();
        }
        
        function updateCartUI(isModalOpen = false) {
            // Atualizar badge
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (totalItems > 0) {
                cartCountBadge.innerText = totalItems;
                cartCountBadge.classList.remove('hidden');
                submitOrderBtn.disabled = false;
            } else {
                cartCountBadge.classList.add('hidden');
                submitOrderBtn.disabled = true;
            }
            
            // Se o modal do carrinho não estiver aberto, não precisa renderizar a lista
            if (!isModalOpen) return;
            
            if (cart.length === 0) {
                cartItemsList.innerHTML = '<p class="text-center text-gray-500 py-6">O seu carrinho está vazio.</p>';
                cartTotal.innerText = 'R$ 0,00';
                return;
            }
            
            cartItemsList.innerHTML = '';
            let totalValue = 0;
            
            cart.forEach(item => {
                totalValue += item.price * item.quantity;
                cartItemsList.innerHTML += `
                    <div class="flex items-center space-x-3 py-2 border-b last:border-b-0">
                        <div class="flex-grow">
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">R$ ${item.price.toFixed(2).replace('.', ',')} (cada)</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${item.id}" class="cart-decrease-btn bg-gray-200 text-gray-700 w-7 h-7 rounded-full font-bold hover:bg-gray-300">-</button>
                            <span class="w-8 text-center font-medium">${item.quantity}</span>
                            <button data-id="${item.id}" class="cart-increase-btn bg-gray-200 text-gray-700 w-7 h-7 rounded-full font-bold hover:bg-gray-300">+</button>
                        </div>
                        <button data-id="${item.id}" class="cart-remove-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `;
            });
            
            cartTotal.innerText = `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
            
            // Adicionar listeners
            document.querySelectorAll('.cart-increase-btn').forEach(btn => btn.addEventListener('click', (e) => adjustCartItem(e.target.dataset.id, 1)));
            document.querySelectorAll('.cart-decrease-btn').forEach(btn => btn.addEventListener('click', (e) => adjustCartItem(e.target.dataset.id, -1)));
            document.querySelectorAll('.cart-remove-btn').forEach(btn => btn.addEventListener('click', (e) => adjustCartItem(e.target.dataset.id, 0)));
        }
        
        function adjustCartItem(productId, amount) {
            const item = cart.find(i => i.id === productId);
            if (!item) return;
            
            if (amount === 0) { // Remover
                cart = cart.filter(i => i.id !== productId);
            } else {
                item.quantity += amount;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== productId);
                }
            }
            updateCartUI(true);
        }
        
        openCartBtn.addEventListener('click', () => {
            updateCartUI(true); // Forçar renderização da lista
            cartModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
        });
        
        closeCartModal.addEventListener('click', () => {
            cartModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        });

        // Enviar Pedido
        submitOrderBtn.addEventListener('click', async () => {
            if (cart.length === 0) return;
            
            submitOrderBtn.disabled = true;
            submitOrderText.innerText = "A enviar...";
            submitOrderSpinner.classList.remove('hidden');
            
            const orderData = {
                tableId: selectedTableId,
                tableName: selectedTableName,
                items: cart,
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                notes: orderNotes.value.trim(),
                status: "pending", // pending, paid, cancelled
                createdAt: Timestamp.now()
            };
            
            try {
                await addDoc(collection(db, getCollectionPath('orders')), orderData);
                
                // Limpar carrinho e UI
                cart = [];
                orderNotes.value = '';
                updateCartUI(true);
                cartModal.classList.add('hidden');
                successModal.classList.remove('hidden');

            } catch (error) {
                console.error("Erro ao enviar pedido: ", error);
                alert("Erro ao enviar pedido. Tente novamente.");
            } finally {
                submitOrderBtn.disabled = false;
                submitOrderText.innerText = "Finalizar Pedido";
                submitOrderSpinner.classList.add('hidden');
            }
        });

        closeSuccessModal.addEventListener('click', () => {
            successModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        });

        // --- Inicialização ---
        initFirebase();

    </script>
</body>
</html>