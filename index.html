<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- html5-qrcode for QR Code scanning -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Style for the QR Code scanner viewfinder */
        #qr-reader-container { position: relative; border-radius: 8px; overflow: hidden; }
        #qr-reader { width: 100%; border: none; }
        
        /* Animation for modals */
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .nav-active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8 hidden">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Acesse sua conta
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Seu controle financeiro pessoal.
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Endereço de e-mail">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Senha</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Senha">
                    </div>
                </div>
                 <p id="auth-error" class="text-sm text-red-500 text-center hidden"></p>

                <div class="flex flex-col space-y-2">
                    <button type="submit" id="login-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Entrar
                    </button>
                    <button type="button" id="register-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Criar Conta
                    </button>
                </div>
            </form>
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-gray-50 text-gray-500">
                        Ou continue com
                    </span>
                </div>
            </div>
            <div>
                <button type="button" id="google-login-btn" class="w-full inline-flex justify-center items-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512">
                        <path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 109.8 512 0 402.2 0 256S109.8 0 244 0c73.2 0 136.2 29.3 182.4 75.4l-62.4 60.3c-27.4-25.9-65.8-42-110-42-83.2 0-151.2 67.9-151.2 151.2s68 151.2 151.2 151.2c96.5 0 128.9-68.9 132.6-103.8H244v-77.2h244z"></path>
                    </svg>
                    Entrar com Google
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <div class="container mx-auto max-w-6xl p-4">
            
            <header class="text-center my-6 relative">
                <h1 class="text-4xl font-bold text-indigo-600">Meu Controle Financeiro</h1>
                <p class="text-gray-500 mt-2">Organize suas finanças de forma simples e eficaz.</p>
                <button id="logout-btn" class="absolute top-0 right-0 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition">
                    Sair
                </button>
            </header>

            <!-- Navigation -->
            <nav class="mb-8 border-b-2 border-gray-200">
                <div class="flex justify-center -mb-px">
                    <button id="nav-dashboard" class="nav-tab nav-active text-lg font-semibold py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-indigo-600 focus:outline-none">Painel Geral</button>
                    <button id="nav-monthly" class="nav-tab text-lg font-semibold py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-indigo-600 focus:outline-none">Acompanhamento Mensal</button>
                </div>
            </nav>

            <!-- Page Content -->
            <div id="page-content">
                <!-- Dashboard Page -->
                <div id="dashboard-page">
                    <main class="space-y-8">
                        <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col items-center justify-center">
                                <h3 class="text-lg font-semibold text-green-500">Total de Receitas</h3>
                                <p id="total-income" class="text-2xl font-bold mt-2">R$ 0,00</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col items-center justify-center">
                                <h3 class="text-lg font-semibold text-red-500">Total de Despesas</h3>
                                <p id="total-expense" class="text-2xl font-bold mt-2">R$ 0,00</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col items-center justify-center">
                                <h3 class="text-lg font-semibold text-blue-500">Saldo Geral</h3>
                                <p id="balance" class="text-2xl font-bold mt-2">R$ 0,00</p>
                            </div>
                        </section>
                        <section class="flex flex-col sm:flex-row items-center justify-center gap-4">
                             <button id="add-transaction-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Adicionar Transação
                            </button>
                            <button id="scan-qr-btn" class="w-full sm:w-auto bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-teal-600 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-400">
                                Ler Cupom Fiscal
                            </button>
                        </section>
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                            <section class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-2xl font-bold mb-4">Últimas Transações (Geral)</h2>
                                <div id="transaction-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                            </section>
                            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md flex flex-col items-center">
                                <h2 class="text-2xl font-bold mb-4">Despesas por Categoria (Geral)</h2>
                                <div class="w-full h-64 flex items-center justify-center">
                                    <canvas id="expense-chart"></canvas>
                                </div>
                            </section>
                        </div>
                    </main>
                </div>

                <!-- Monthly Tracking Page -->
                <div id="monthly-page" class="hidden">
                    <main class="space-y-8">
                        <section class="bg-white p-6 rounded-xl shadow-md">
                             <div class="flex justify-between items-center mb-4">
                                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <h2 id="month-display" class="text-2xl font-bold text-indigo-600"></h2>
                                <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <h3 class="text-lg font-semibold text-green-600">Receitas do Mês</h3>
                                    <p id="monthly-income" class="text-2xl font-bold mt-2">R$ 0,00</p>
                                </div>
                                <div class="p-4 bg-red-50 rounded-lg">
                                    <h3 class="text-lg font-semibold text-red-600">Despesas do Mês</h3>
                                    <p id="monthly-expense" class="text-2xl font-bold mt-2">R$ 0,00</p>
                                </div>
                                <div class="p-4 bg-blue-50 rounded-lg">
                                    <h3 class="text-lg font-semibold text-blue-600">Saldo do Mês</h3>
                                    <p id="monthly-balance" class="text-2xl font-bold mt-2">R$ 0,00</p>
                                </div>
                            </div>
                        </section>
                        <section class="bg-white p-6 rounded-xl shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">Transações do Mês</h2>
                                <button id="carry-over-btn" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-600 transition hidden">
                                    Transferir Pendentes
                                </button>
                            </div>
                            <div id="monthly-transaction-list" class="space-y-4"></div>
                        </section>
                    </main>
                </div>
            </div>
            <footer class="text-center mt-8">
                <p class="text-xs text-gray-400">Logado como: <span id="user-email" class="font-mono"></span></p>
            </footer>
        </div>

        <!-- Modals and Notifications -->
        <div id="transaction-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
                <h2 id="modal-title" class="text-2xl font-bold mb-6">Adicionar Nova Transação</h2>
                <form id="transaction-form" class="space-y-4">
                    <input type="hidden" id="transaction-id">
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Descrição</label>
                        <input type="text" id="description" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                        <input type="number" id="amount" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: 50.75" required>
                    </div>
                     <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" id="date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="expense">Despesa</option>
                            <option value="income">Receita</option>
                        </select>
                    </div>
                    <div id="category-section">
                        <label for="category" class="block text-sm font-medium text-gray-700">Categoria</label>
                        <select id="category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option>Alimentação</option>
                            <option>Transporte</option>
                            <option>Combustível</option>
                            <option>Moradia</option>
                            <option>Lazer</option>
                            <option>Saúde</option>
                            <option>Outros</option>
                        </select>
                    </div>
                    <div id="fuel-details-section" class="hidden">
                        <label for="liters" class="block text-sm font-medium text-gray-700">Litros (L)</label>
                        <input type="number" id="liters" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: 40.5">
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="qr-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg modal-enter">
                <h2 class="text-2xl font-bold mb-2">Ler QR Code do Cupom Fiscal</h2>
                <p class="text-sm text-gray-600 mb-4">Aponte a câmera para o QR Code. Depois, adicione o valor total e a categoria manualmente.</p>
                <div id="qr-reader-container" class="w-full bg-gray-100 rounded-lg"><div id="qr-reader"></div></div>
                <div id="qr-scan-result" class="mt-4 text-center text-green-600 font-medium hidden"></div>
                <button id="close-qr-modal" class="mt-4 w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Fechar Leitor</button>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <!-- Firebase -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO ---
        const firebaseConfig = {
            apiKey: "AIzaSyBL0W-wKIEKWnngq1wfgiqocOrdUdYeuJ4",
            authDomain: "financeiro-e6c9e.firebaseapp.com",
            projectId: "financeiro-e6c9e",
            storageBucket: "financeiro-e6c9e.appspot.com",
            messagingSenderId: "1073652915131",
            appId: "1:1073652915131:web:1621491a814c202419029e"
        };
        const appId = "financeiro-e6c9e";

        let app, db, auth, userId, expenseChart;
        let allTransactions = [];
        let html5QrCode;
        let unsubscribeFromFirestore = null;
        let currentMonthDate = new Date();

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                setupAuthListener();
                setupEventListeners();
                initializeChart();
            } catch (error) {
                console.error("Erro ao inicializar:", error);
                showToast("Erro de conexão. Tente recarregar a página.", true);
            }
        });

        // --- AUTENTICAÇÃO ---
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                const loginScreen = document.getElementById('login-screen');
                const appScreen = document.getElementById('app-screen');

                if (user) {
                    userId = user.uid;
                    document.getElementById('user-email').textContent = user.email || 'Usuário';
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    setupRealtimeListeners();
                } else {
                    userId = null;
                    loginScreen.classList.remove('hidden');
                    appScreen.classList.add('hidden');
                    if (unsubscribeFromFirestore) unsubscribeFromFirestore();
                    allTransactions = [];
                    updateUI();
                }
            });
        }

        // --- BANCO DE DADOS (FIRESTORE) ---
        function setupRealtimeListeners() {
            if (!userId) return;
            if (unsubscribeFromFirestore) unsubscribeFromFirestore();

            const transactionsCollection = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            const q = query(transactionsCollection);

            unsubscribeFromFirestore = onSnapshot(q, (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allTransactions.forEach(t => {
                    if (t.date && typeof t.date.toDate === 'function') {
                        t.date = t.date.toDate();
                    }
                });
                updateUI();
            }, (error) => {
                console.error("Erro ao buscar transações:", error);
                showToast("Não foi possível carregar as transações.", true);
            });
        }
        
        async function saveTransaction(data) {
            if (!userId) {
                showToast("Você precisa estar logado para salvar.", true);
                return;
            }
            try {
                const transactionId = data.id;
                const dataToSave = {
                    description: data.description,
                    amount: data.amount,
                    type: data.type,
                    category: data.category,
                    date: new Date(data.date + 'T00:00:00'),
                    paid: data.type === 'income' ? true : (data.paid || false),
                    liters: data.liters || null
                };

                const transactionsCollection = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
                
                if (transactionId) {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'transactions', transactionId);
                    await updateDoc(docRef, dataToSave);
                    showToast("Transação atualizada com sucesso!");
                } else {
                    dataToSave.createdAt = serverTimestamp();
                    await addDoc(transactionsCollection, dataToSave);
                    showToast("Transação adicionada com sucesso!");
                }
            } catch (error) {
                console.error("Erro ao salvar transação:", error);
                showToast("Erro ao salvar a transação.", true);
            }
        }

        async function togglePaidStatus(id, currentStatus) {
            if (!userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'transactions', id);
            await updateDoc(docRef, { paid: !currentStatus });
        }

        async function carryOverPending() {
            if (!userId) return;

            const pendingTransactions = getTransactionsForMonth(currentMonthDate).filter(t => t.type === 'expense' && !t.paid);
            if (pendingTransactions.length === 0) {
                showToast("Nenhuma despesa pendente para transferir.");
                return;
            }

            const nextMonth = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + 1, 1);
            
            const batch = writeBatch(db);
            pendingTransactions.forEach(t => {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'transactions', t.id);
                const newDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), t.date.getDate());
                batch.update(docRef, { date: newDate });
            });

            await batch.commit();
            showToast(`${pendingTransactions.length} despesa(s) transferida(s) para o próximo mês.`);
            currentMonthDate = nextMonth;
            updateUI();
        }

        async function deleteTransaction(id) {
            if (!userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'transactions', id);
            await deleteDoc(docRef);
            showToast("Transação excluída.");
        }

        // --- LÓGICA DA UI ---
        function updateUI() {
            updateDashboardPage();
            updateMonthlyPage();
        }
        
        function updateDashboardPage() {
            const totalIncome = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;

            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            const balanceEl = document.getElementById('balance');
            balanceEl.textContent = formatCurrency(balance);
            balanceEl.classList.toggle('text-red-500', balance < 0);
            balanceEl.classList.toggle('text-blue-500', balance >= 0);

            updateTransactionList(allTransactions, 'transaction-list');
            updateChart();
        }

        function updateMonthlyPage() {
            const monthDisplay = document.getElementById('month-display');
            monthDisplay.textContent = currentMonthDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());

            const monthlyTransactions = getTransactionsForMonth(currentMonthDate);
            
            const monthlyIncome = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const monthlyExpense = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const monthlyBalance = monthlyIncome - monthlyExpense;

            document.getElementById('monthly-income').textContent = formatCurrency(monthlyIncome);
            document.getElementById('monthly-expense').textContent = formatCurrency(monthlyExpense);
            document.getElementById('monthly-balance').textContent = formatCurrency(monthlyBalance);

            updateTransactionList(monthlyTransactions, 'monthly-transaction-list');

            const carryOverBtn = document.getElementById('carry-over-btn');
            const pendingCount = monthlyTransactions.filter(t => t.type === 'expense' && !t.paid).length;
            if (pendingCount > 0) {
                carryOverBtn.classList.remove('hidden');
                carryOverBtn.textContent = `Transferir ${pendingCount} Pendente(s)`;
            } else {
                carryOverBtn.classList.add('hidden');
            }
        }

        function getTransactionsForMonth(date) {
            return allTransactions.filter(t => {
                const tDate = t.date;
                return tDate && tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear();
            });
        }

        function formatCurrency(value) {
            return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function updateTransactionList(transactions, listId) {
            const listEl = document.getElementById(listId);
            listEl.innerHTML = '';
            if (transactions.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma transação registrada.</p>';
                return;
            }
            
            const sortedTransactions = [...transactions].sort((a,b) => (a.date > b.date) ? 1 : -1);

            sortedTransactions.forEach(t => {
                const isExpense = t.type === 'expense';
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 ${!t.paid && isExpense ? 'bg-red-50' : ''}`;
                
                let statusToggle = '';
                if (isExpense) {
                    statusToggle = `
                        <button class="toggle-paid-btn text-sm font-semibold py-1 px-2 rounded-full ${t.paid ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}" data-id="${t.id}" data-paid="${t.paid}">
                            ${t.paid ? 'Paga' : 'Pendente'}
                        </button>
                    `;
                }

                let subtitle = `${t.category || 'Receita'} - ${t.date ? t.date.toLocaleDateString('pt-BR') : 'Data não registrada'}`;
                if (t.category === 'Combustível' && t.liters) {
                    subtitle = `${t.category} (${t.liters} L) - ${t.date ? t.date.toLocaleDateString('pt-BR') : 'Data não registrada'}`;
                }

                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div>
                            <p class="font-semibold">${t.description}</p>
                            <p class="text-sm text-gray-500">${subtitle}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        ${statusToggle}
                        <div class="text-right">
                            <p class="font-bold ${isExpense ? 'text-red-600' : 'text-green-600'}">${formatCurrency(t.amount)}</p>
                            <div class="text-xs space-x-2 mt-1">
                                <button class="text-blue-500 hover:underline edit-btn" data-id="${t.id}">Editar</button>
                                <button class="text-red-500 hover:underline delete-btn" data-id="${t.id}">Excluir</button>
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        // --- GRÁFICO ---
        function initializeChart() {
            const ctx = document.getElementById('expense-chart').getContext('2d');
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#EF4444', '#F97316', '#EAB308', '#84CC16', '#22C55E', '#14B8A6', '#0EA5E9', '#6366F1', '#A855F7'], borderColor: '#fff', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15 } }, tooltip: { callbacks: { label: (c) => `${c.label || ''}: ${formatCurrency(c.parsed)}` } } } }
            });
        }

        function updateChart() {
            const expenses = allTransactions.filter(t => t.type === 'expense');
            const spendingByCategory = expenses.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});
            expenseChart.data.labels = Object.keys(spendingByCategory);
            expenseChart.data.datasets[0].data = Object.values(spendingByCategory);
            expenseChart.update();
        }

        // --- EVENTOS ---
        function setupEventListeners() {
            // Auth
            document.getElementById('login-form').addEventListener('submit', handleEmailLogin);
            document.getElementById('register-btn').addEventListener('click', handleEmailRegister);
            document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            // Navigation
            document.getElementById('nav-dashboard').addEventListener('click', () => switchPage('dashboard-page'));
            document.getElementById('nav-monthly').addEventListener('click', () => switchPage('monthly-page'));
            // Dashboard
            document.getElementById('add-transaction-btn').addEventListener('click', () => openModal());
            document.getElementById('scan-qr-btn').addEventListener('click', startQrScanner);
            // Monthly
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
            document.getElementById('carry-over-btn').addEventListener('click', carryOverPending);
            // Modals
            document.getElementById('cancel-btn').addEventListener('click', () => closeModal());
            document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('type').addEventListener('change', toggleCategory);
            document.getElementById('category').addEventListener('change', toggleCategory);
            document.getElementById('close-qr-modal').addEventListener('click', () => stopQrScanner());
            // Dynamic lists
            document.getElementById('page-content').addEventListener('click', handleListClick);
        }
        
        function switchPage(pageId) {
            document.getElementById('dashboard-page').classList.add('hidden');
            document.getElementById('monthly-page').classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');

            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('nav-active'));
            const activeTabId = pageId === 'dashboard-page' ? 'nav-dashboard' : 'nav-monthly';
            document.getElementById(activeTabId).classList.add('nav-active');
        }

        function changeMonth(direction) {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + direction);
            updateMonthlyPage();
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const data = {
                id: document.getElementById('transaction-id').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: type,
                category: type === 'expense' ? category : null,
                date: document.getElementById('date').value,
                liters: category === 'Combustível' ? parseFloat(document.getElementById('liters').value) : null
            };
            saveTransaction(data);
            closeModal();
        }

        function handleListClick(e) {
            const target = e.target;
            if (target.classList.contains('delete-btn')) {
                deleteTransaction(target.dataset.id);
            } else if (target.classList.contains('edit-btn')) {
                const transaction = allTransactions.find(t => t.id === target.dataset.id);
                if (transaction) openModal(transaction);
            } else if (target.classList.contains('toggle-paid-btn')) {
                togglePaidStatus(target.dataset.id, target.dataset.paid === 'true');
            }
        }
        
        // --- HANDLERS DE AUTENTICAÇÃO ---
        function showAuthError(message) {
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
        function clearAuthError() { document.getElementById('auth-error').classList.add('hidden'); }
        async function handleEmailLogin(e) {
            e.preventDefault(); clearAuthError();
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { showAuthError("E-mail ou senha inválidos."); }
        }
        async function handleEmailRegister(e) {
            e.preventDefault(); clearAuthError();
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            if (password.length < 6) { showAuthError("A senha deve ter pelo menos 6 caracteres."); return; }
            try { await createUserWithEmailAndPassword(auth, email, password); } 
            catch (error) {
                if (error.code === 'auth/email-already-in-use') showAuthError("Este e-mail já está em uso.");
                else showAuthError("Não foi possível criar a conta.");
            }
        }
        async function handleGoogleLogin() {
            clearAuthError();
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } 
            catch (error) {
                if (error.code === 'auth/unauthorized-domain') {
                    console.log(`O domínio que precisa ser autorizado é: ${window.location.hostname}`);
                    showAuthError("Domínio não autorizado. Adicione o domínio do console (F12) no seu projeto Firebase.");
                } else { showAuthError("Não foi possível fazer login com o Google."); }
            }
        }
        async function handleLogout() { try { await signOut(auth); } catch (error) { showToast("Erro ao tentar sair.", true); } }

        function openModal(transaction = null) {
            const modal = document.getElementById('transaction-modal');
            const form = document.getElementById('transaction-form');
            form.reset();
            document.getElementById('transaction-id').value = '';
            
            if (transaction) {
                document.getElementById('modal-title').textContent = 'Editar Transação';
                document.getElementById('transaction-id').value = transaction.id || '';
                document.getElementById('description').value = transaction.description || '';
                document.getElementById('amount').value = transaction.amount || '';
                document.getElementById('date').value = transaction.date ? transaction.date.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
                document.getElementById('type').value = transaction.type || 'expense';
                if(transaction.type === 'expense') {
                    document.getElementById('category').value = transaction.category || 'Outros';
                    if(transaction.category === 'Combustível' && transaction.liters) {
                        document.getElementById('liters').value = transaction.liters;
                    }
                }
            } else {
                document.getElementById('modal-title').textContent = 'Adicionar Nova Transação';
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }
            toggleCategory();
            modal.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('transaction-modal').classList.add('hidden'); }
        function toggleCategory() { 
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const categorySection = document.getElementById('category-section');
            const fuelSection = document.getElementById('fuel-details-section');

            if (type === 'expense') {
                categorySection.style.display = 'block';
                if (category === 'Combustível') {
                    fuelSection.style.display = 'block';
                } else {
                    fuelSection.style.display = 'hidden';
                }
            } else {
                categorySection.style.display = 'none';
                fuelSection.style.display = 'none';
            }
        }

        // --- LÓGICA DO QR CODE ---
        function startQrScanner() {
            const qrModal = document.getElementById('qr-modal');
            qrModal.classList.remove('hidden');
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const onScanSuccess = (decodedText) => {
                stopQrScanner(false);
                window.open(decodedText, '_blank');
                setTimeout(() => {
                    qrModal.classList.add('hidden');
                    openModal();
                    showToast("Agora, adicione os detalhes da sua compra.");
                }, 1500);
            };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, () => {}).catch(() => {
                showToast("Não foi possível acessar a câmera.", true);
                stopQrScanner();
            });
        }
        function stopQrScanner(closeModal = true) {
            if (html5QrCode?.isScanning) {
                html5QrCode.stop().catch(err => console.error("Erro ao parar o leitor.", err));
            }
            if (closeModal) document.getElementById('qr-modal').classList.add('hidden');
        }

        // --- NOTIFICAÇÕES (TOAST) ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-green-500'}`;
            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
            }, 3000);
        }
    </script>

</body>
</html>
